name: AIME Staging Deploy (manual)

on:
  workflow_dispatch:

jobs:
  deploy-staging:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    env:
      NODE_ENV: staging
      FEATURE_ADMIN_ONLY: "true"
      FEATURE_PARTNER: "false"
      FEATURE_MEMBERS: "false"
      FEATURE_SIGNAL_NETWORK: "false"   # DO NOT set true until Trigger Map QA = Complete

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # BACKEND
      - name: Install backend deps
        working-directory: server
        run: npm install

      - name: Build backend
        working-directory: server
        run: npm run build

      - name: Start backend server
        working-directory: server
        run: |
          nohup npm start > server.log 2>&1 &
          sleep 8

      - name: Run backend smoke
        working-directory: server
        run: npm run smoke

      - name: Print backend logs (if smoke fails)
        if: failure()
        working-directory: server
        run: cat server.log


      # FRONTEND
      - name: Install web deps
        working-directory: web
        run: npm install

      - name: Fix vite permission
        working-directory: web
        run: chmod +x ./node_modules/.bin/vite || true

      - name: Build web
        working-directory: web
        run: npm run build

      - name: Deployment complete
        run: echo "Staging build completed successfully."
